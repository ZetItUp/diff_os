[BITS 32]

extern printf
extern GDT_USER_CS_SEL
extern GDT_USER_DS_SEL

global enter_user_mode
global enter_user_mode_ex
global dump_dwords

%define USER_BASE        0x40000000
%define EFLAGS_CF        0x00000001
%define EFLAGS_PF        0x00000004
%define EFLAGS_AF        0x00000010
%define EFLAGS_ZF        0x00000040
%define EFLAGS_SF        0x00000080
%define EFLAGS_TF        0x00000100
%define EFLAGS_IF        0x00000200
%define EFLAGS_DF        0x00000400
%define EFLAGS_OF        0x00000800
%define EFLAGS_IOPL      0x00003000
%define EFLAGS_NT        0x00004000
%define EFLAGS_RF        0x00010000
%define EFLAGS_VM        0x00020000
%define EFLAGS_VIF       0x00080000
%define EFLAGS_VIP       0x00100000
%define DEF_SET_MASK     (EFLAGS_IF | EFLAGS_RF)
%define DEF_CLR_MASK     (EFLAGS_TF | EFLAGS_NT | EFLAGS_VM | EFLAGS_VIF | EFLAGS_VIP | EFLAGS_IOPL)
%define MASK_CLR_IF_TF_NT    0xFFFFBDFF
%define L_EIP              -4
%define L_ESP              -8
%define L_CS               -12
%define L_DS               -16
%define L_EFLAGS_KRN       -20
%define L_CS_KRN           -24
%define L_DS_KRN           -28
%define L_SS_KRN           -32
%define L_CR3              -36
%define L_UCS_RAW          -40
%define L_UDS_RAW          -44
%define L_EFLAGS_IRET      -48
%define L_TMP0             -52
%define L_TMP1             -56
%define L_FRAME_BYTES      -60
%define L_FRAME_BOT        -64
%define L_DUMP_START       -68
%define L_DUMP_COUNT       -72
%define L_PROJ_START       -76
%define L_PROJ_COUNT       -80

section .rodata
fmt_enter_hdr      db "[enter_user_mode] entry_eip=%08x user_stack_top=%08x",10,0
fmt_switch         db "[enter_user_mode] switching to ring3...",10,0
fmt_bad_eip        db "[enter_user_mode][FATAL] entry_eip under USER_BASE!",10,0
fmt_bad_esp        db "[enter_user_mode][FATAL] user_stack_top under USER_BASE!",10,0
fmt_kregs          db "[enter_user_mode] kernel segs: cs=%04x ds=%04x ss=%04x eflags=%08x cr3=%08x",10,0
fmt_gdt_vals       db "[enter_user_mode] GDT sel (raw): USER_CS=%04x USER_DS=%04x  (after RPL|3: cs=%04x ds=%04x)",10,0
fmt_set_dataseg    db "[enter_user_mode] preload DS/ES/FS/GS=%04x",10,0
fmt_align_warn     db "[enter_user_mode] WARN: user ESP not 16-byte aligned (%08x)",10,0
fmt_eflags_patch   db "[enter_user_mode] patch EFLAGS (kernel &~clear)|set => %08x",10,0
fmt_iret_frame     db "[enter_user_mode] IRET frame -> SS=%04x ESP=%08x EFLAGS=%08x CS=%04x EIP=%08x",10,0
fmt_iret_about     db "IRET frame about to push: eip=%08x cs=%04x efl=%08x esp=%08x ss=%04x",10,0
fmt_kesp_before    db "Kernel ESP before pushing: %08x",10,0
fmt_stack_hdr_pre  db "[stack] BEFORE IRET: ebp=%08x esp=%08x (dump %u dwords @%08x)",10,0
fmt_stack_hdr_plan db "[stack] PROJECTION:  IRET frame will occupy %u bytes at %08x..%08x",10,0
fmt_stack_row      db "  %08x: %08x %08x %08x %08x",10,0

section .text

dump_dwords:
    push    ebp
    mov     ebp, esp
    push    esi
    push    edi
    mov     esi, [ebp+8]
    mov     ecx, [ebp+12]
.next_row:
    test    ecx, ecx
    jz      .done
    mov     eax, esi
    mov     ebx, [esi+0]
    mov     edx, [esi+4]
    push    dword [esi+12]
    push    dword [esi+8]
    push    dword edx
    push    dword ebx
    push    dword eax
    push    dword fmt_stack_row
    add     esp, 24
    lea     esi, [esi+16]
    sub     ecx, 4
    jmp     .next_row
.done:
    pop     edi
    pop     esi
    mov     esp, ebp
    pop     ebp
    ret

enter_user_mode:
    push    ebp
    mov     ebp, esp
    push    dword DEF_CLR_MASK
    push    dword DEF_SET_MASK
    push    dword [ebp+12]
    push    dword [ebp+8]
    call    enter_user_mode_ex
    add     esp, 16
    mov     esp, ebp
    pop     ebp
    ret

enter_user_mode_ex:
    push    ebp
    mov     ebp, esp
    sub     esp, 80
    mov     eax, [ebp+8]
    mov     edx, [ebp+12]
    mov     [ebp+L_EIP], eax
    mov     [ebp+L_ESP], edx
    push    dword [ebp+L_ESP]
    push    dword [ebp+L_EIP]
    push    dword fmt_enter_hdr
    call    printf
    add     esp, 12
    mov     eax, [ebp+L_EIP]
    cmp     eax, USER_BASE
    jb      .bad_eip
    mov     edx, [ebp+L_ESP]
    cmp     edx, USER_BASE
    jb      .bad_esp
    movzx   eax, word [GDT_USER_CS_SEL]
    movzx   edx, word [GDT_USER_DS_SEL]
    or      eax, 3
    or      edx, 3
    mov     [ebp+L_UCS_RAW], eax
    mov     [ebp+L_UDS_RAW], edx
    mov     [ebp+L_CS],     eax
    mov     [ebp+L_DS],     edx
    pushfd
    pop     ecx
    mov     [ebp+L_EFLAGS_KRN], ecx
    mov     ax, cs
    mov     [ebp+L_CS_KRN], eax
    mov     ax, ds
    mov     [ebp+L_DS_KRN], eax
    mov     ax, ss
    mov     [ebp+L_SS_KRN], eax
    mov     eax, 0
    mov     edx, 0
    mov     eax, cr3
    mov     [ebp+L_CR3], eax
    push    dword [ebp+L_CR3]
    push    dword [ebp+L_EFLAGS_KRN]
    push    dword [ebp+L_SS_KRN]
    push    dword [ebp+L_DS_KRN]
    push    dword [ebp+L_CS_KRN]
    push    dword fmt_kregs
    call    printf
    add     esp, 24
    mov     eax, [ebp+L_UCS_RAW]
    mov     edx, [ebp+L_UDS_RAW]
    push    dword edx
    push    dword eax
    push    dword edx
    push    dword eax
    push    dword [GDT_USER_DS_SEL]
    push    dword [GDT_USER_CS_SEL]
    push    dword fmt_gdt_vals
    call    printf
    add     esp, 28
    cld
    mov     eax, [ebp+L_ESP]
    and     eax, 15
    jz      .no_align_warn
    push    dword [ebp+L_ESP]
    push    dword fmt_align_warn
    call    printf
    add     esp, 8
.no_align_warn:
    mov     eax, [ebp+L_EFLAGS_KRN]
    mov     edx, [ebp+16]
    mov     ecx, [ebp+20]
    not     ecx
    and     eax, ecx
    or      eax, edx
    and     eax, (0xFFFFFFFF ^ EFLAGS_IOPL)
    mov     [ebp+L_EFLAGS_IRET], eax
    push    dword [ebp+L_EFLAGS_IRET]
    push    dword fmt_eflags_patch
    call    printf
    add     esp, 8
    mov     dword [ebp+L_FRAME_BYTES], 20
    mov     eax, esp
    mov     [ebp+L_DUMP_START], eax
    mov     dword [ebp+L_DUMP_COUNT], 32
    push    dword [ebp+L_DUMP_START]
    push    dword [ebp+L_DUMP_COUNT]
    push    dword esp
    push    dword ebp
    push    dword fmt_stack_hdr_pre
    call    printf
    add     esp, 20
    push    dword [ebp+L_DUMP_COUNT]
    push    dword [ebp+L_DUMP_START]
    call    dump_dwords
    add     esp, 8
    mov     eax, esp
    sub     eax, [ebp+L_FRAME_BYTES]
    mov     [ebp+L_FRAME_BOT], eax
    mov     edx, [ebp+L_FRAME_BOT]
    sub     edx, 32
    mov     [ebp+L_PROJ_START], edx
    mov     dword [ebp+L_PROJ_COUNT], 16
    mov     eax, [ebp+L_FRAME_BOT]
    mov     ecx, [ebp+L_FRAME_BYTES]
    lea     edx, [eax+ecx-1]
    push    dword edx
    push    dword eax
    push    dword [ebp+L_FRAME_BYTES]
    push    dword fmt_stack_hdr_plan
    call    printf
    add     esp, 16
    push    dword [ebp+L_PROJ_COUNT]
    push    dword [ebp+L_PROJ_START]
    call    dump_dwords
    add     esp, 8
    push    dword [ebp+L_DS]
    push    dword [ebp+L_ESP]
    push    dword [ebp+L_EFLAGS_IRET]
    push    dword [ebp+L_CS]
    push    dword [ebp+L_EIP]
    push    dword fmt_iret_about
    call    printf
    add     esp, 24
    mov     eax, esp
    push    eax
    push    dword fmt_kesp_before
    call    printf
    add     esp, 8
    cli
    push    dword [ebp+L_DS]
    push    dword [ebp+L_ESP]
    push    dword [ebp+L_EFLAGS_IRET]
    push    dword [ebp+L_CS]
    push    dword [ebp+L_EIP]
    iretd

.bad_eip:
    push    dword fmt_bad_eip
    call    printf
    add     esp, 4
    jmp     $

.bad_esp:
    push    dword fmt_bad_esp
    call    printf
    add     esp, 4
    jmp     $

